<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create User Credentials</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <button id="createButton">Create</button>
    <button id="registerButton">Register</button>
    <button id="loginButton">Log in</button>

    <script>
        console.log("init");
        document.getElementById('createButton').addEventListener('click', authenticate);
        document.getElementById('registerButton').addEventListener('click', register);
        document.getElementById('loginButton').addEventListener('click', login);

        async function register() {
            console.log("register");

            // begin registration
            const beginRsp = await fetch(`/webauthn/begin-registration`, { method: 'POST' });
            const options = await beginRsp.json();
            console.log("options from server:",options)
            const publicKeyCredentialCreationOptions = {
                challenge: Uint8Array.from(options.publicKey.challenge, c => c.charCodeAt(0)),
                rp: options.publicKey.rp,
                user: {
                    id:Uint8Array.from(options.publicKey.user.id, c => c.charCodeAt(0)) ,
                    name: options.publicKey.user.name,
                    displayName: options.publicKey.user.displayName,
                },
                pubKeyCredParams:options.publicKey.pubKeyCredParams,
                // authenticatorSelection: {
                //      authenticatorAttachment: "platform",
                // },
                timeout: 30000,
                // attestation: "direct"
            };
            console.log(publicKeyCredentialCreationOptions)
            console.log("origChallenge", options.publicKey.challenge)
            console.log("encodedChallenge", publicKeyCredentialCreationOptions.challenge)
            credential = await navigator.credentials.create({ publicKey: publicKeyCredentialCreationOptions })


            // finish registration
            console.log("credential:", credential)
            console.log(new TextDecoder().decode(credential.response.clientDataJSON))
            const finishRsp = await fetch(`/webauthn/finish-registration`, {
                method: "POST",
                body: JSON.stringify(credential)
            });

            console.log("finish-registration response:", await finishRsp.text());
        }

        async function login() {
            console.log("login");
            const beginRsp = await fetch(`/webauthn/begin-login`, { method: 'POST' });
            const options = await beginRsp.json();
            console.log("options from server:",options)
            const publicKeyCredentialRequestOptions = {
                challenge: Uint8Array.from(options.publicKey.challenge, c => c.charCodeAt(0)),
                rpId:  options.publicKey.rpId,
                timeout:  options.publicKey.timeout,
                allowCredentials: [{
                    id: Uint8Array.from(options.publicKey.allowCredentials[0].id, c => c.charCodeAt(0)),
                    type: options.publicKey.allowCredentials[0].type,
                    transports: options.publicKey.allowCredentials[0].transports,
                }],
            }
            const credential = await navigator.credentials.get({publicKey: publicKeyCredentialRequestOptions}); 

            const response = await fetch(`/webauthn/finish-login`, {
                method: "POST",
                body: JSON.stringify(credential)
            });

            console.log(await response.text());
        }

        async function authenticate () {
            console.log("onClick");
            const challengeFromServer = new TextEncoder().encode("challengeFromServer").buffer;
            const publicKey = {
                challenge: challengeFromServer,
                rp: { id: "localhost", name: "gostudy fido2" },
                user: {
                    id: new Uint8Array([79, 252, 83, 72, 214, 7, 89, 26]),
                    name: "testuser",
                    displayName: "Test User",
                },
                pubKeyCredParams: [{ type: "public-key", alg: -7 }],
            };
            console.log(publicKey)
            // rsp = await navigator.credentials.create({ publicKey }).then(handleCreateCredentialsResponse);
            rsp = await navigator.credentials.create({ publicKey })
            handleCreateCredentialsResponse(rsp);
        }

        function handleCreateCredentialsResponse(publicKeyCredential) {
            const response = publicKeyCredential.response;

            console.log("PublicKeyCredential:", publicKeyCredential);

            // attestationObject
            const attestationObj = response.attestationObject;
            console.log("Attestation Object:", new Uint8Array(attestationObj));

            // ID
            console.log("ID:", publicKeyCredential.id);

            // RawID
            const rawID = new TextDecoder().decode(publicKeyCredential.rawId)
            console.log("Raw ID:", rawID);

            // Type
            console.log("Type:", publicKeyCredential.type);

            // authenticator data
            const authenticatorData = new TextDecoder().decode(response.getAuthenticatorData());
            console.log("Authenticator Data:", authenticatorData);
            
            // public key ArrayBuffer
            const pk = new TextDecoder().decode(response.getPublicKey());
            console.log("Public Key:",pk);
            
            // public key algorithm identifier
            const pkAlgo = response.getPublicKeyAlgorithm();
            console.log("Public Key Algorithm:", pkAlgo);
            
            response.getAuthenticatorData
            // permissible transports array
            const transports = response.getTransports();
            console.log("Transports:", transports);

            // Access client JSON
            const clientJSON = new TextDecoder().decode(response.clientDataJSON);
            console.log("Client Data JSON:", clientJSON);

            // Convert the publicKeyCredential to a JSON object
            const credentialData = {
                id: publicKeyCredential.id,
                rawId: rawID,
                type: publicKeyCredential.type,
                authenticatorData: authenticatorData,
                publicKey: pk,
                publicKeyAlgorithm: pkAlgo,
                transports: transports,
                response: {
                    attestationObject:  new TextDecoder().decode(response.attestationObject),
                    clientDataJSON: clientJSON
                }
            };

            // Send the JSON object to the /auth endpoint using a POST request
            fetch('/auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(credentialData)
            })
            .then(response => {
                if (response.ok) {
                    console.log('Success: HTTP Status', response.status);
                } else {
                    console.error('Error: HTTP Status', response.status);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    </script>
</body>

</html>