# redis streams

Redis introduction to streams <https://redis.io/topics/streams-intro>  
Streams CLI examples:
- <https://youtu.be/O_jNJ32s6x8?t=1385>  
- <https://www.youtube.com/watch?v=qXEyuUxQXZM>

## Highlights

- stream is like append-only log file that can be read by entry-id
- streams in contrast to pubsub don't loose messages (they are buffered)

## Play around with redis shell (first: ./run_all.sh)

Redis shell commands: <https://redis.io/commands/#stream>

```bash
# start server
docker run --rm --name streams redis

# start writer in terminal 1 and add messages
docker exec -it streams redis-cli
127.0.0.1:6379> xadd messages * "color" "RED" # add {color: RED} msg to stream "messages", * = autogenerate msg ID; you can provide own ID instead
"1605721596541-0"  # autogenerated msg ID; this "millisecond:seq number", for querring msgs by ranges of time
127.0.0.1:6379> xadd messages * "color" "GREEN"
"1605721607906-0"
127.0.0.1:6379> xadd messages * "color" "BLUE"
"1605721612426-0"

# start reader in terminal 2 and read 3 messages
docker exec -it streams redis-cli
127.0.0.1:6379> xread count 3 streams messages 0 # read 3 messages from stream "messages", start from msgID 0
1) 1) "messages"
   2) 1) 1) "1605721596541-0"
         2) 1) "color"
            2) "RED"
      2) 1) "1605721607906-0"
         2) 1) "color"
            2) "GREEN"
      3) 1) "1605721612426-0"
         2) 1) "color"
            2) "BLUE"

# read message that was inserted after ID 1605721596541-0
127.0.0.1:6379> xread count 1 streams messages 1605721596541-0 # ID of "color:RED" message
1) 1) "messages"
   2) 1) 1) "1605721607906-0"
         2) 1) "color"
            2) "GREEN"

# wait until fresh message is added
127.0.0.1:6379> xread block 0 streams messages $ # "$" means: use highest ID in the stream
# blocks until new message is added...
1) 1) "messages"
   2) 1) 1) "1605722512292-0"
         2) 1) "color"
            2) "WHITE"

# read subrange of messages
127.0.0.1:6379> xrange messages 1605721607906-0 1605721612426-0
1) 1) "1605721607906-0"
   2) 1) "color"
      2) "GREEN"
2) 1) "1605721612426-0"
   2) 1) "color"
      2) "BLUE"

# read the last message in the stream
127.0.0.1:6379> xrevrange messages + - count 1 # xrevrange: read in reverse order, "+ -": read all messages, count 1: return first message
1) 1) "1605721612426-0"
   2) 1) "color"
      2) "BLUE"

### CONSUMER GROUPS - distribute messages between clients in round robin style, eg. for parallel processing

# create stream "messages" with items
127.0.0.1:6379> xadd messages * vegetable carrot
"1605728508606-0"
127.0.0.1:6379> xadd messages * vegetable chive
"1605728515552-0"
127.0.0.1:6379> xadd messages * vegetable tomato
"1605728529174-0"
127.0.0.1:6379> xadd messages * vegetable onion
"1605728537148-0"
127.0.0.1:6379> xadd messages * vegetable garlic
"1605728551793-0"

# create consumer group vege
127.0.0.1:6379> xgroup create messages vege $ # create group "vege", "$" means give me only new items
OK

# read items one by one, this can be done by many clients (iva, albert, jakub) and each will receive unique item
127.0.0.1:6379> XREADGROUP group vege iva count 1 streams messages  > # ">" means: give me a fresh item. "0" means: give me my unacknowledged items
1) 1) "messages"
   2) 1) 1) "1605728515552-0"
         2) 1) "vegetable"
            2) "chive"
127.0.0.1:6379> XREADGROUP group vege iva count 1 streams messages  >
1) 1) "messages"
   2) 1) 1) "1605728529174-0"
         2) 1) "vegetable"
            2) "tomato"
127.0.0.1:6379> XREADGROUP group vege iva count 1 streams messages  >
1) 1) "messages"
   2) 1) 1) "1605728537148-0"
         2) 1) "vegetable"
            2) "onion"

# get list of items that we received and did not acknowledged
127.0.0.1:6379> XREADGROUP group vege iva  streams messages 0 # "0" gives us the non-acknowledged ones
       1) 1) "1605728515552-0"
          2) 1) "vegetable"
             2) "chive"
       2) 1) "1605728529174-0"
          2) 1) "vegetable"
             2) "tomato"
       3) 1) "1605728537148-0"
          2) 1) "vegetable"
             2) "onion"

# ack "chive"
127.0.0.1:6379> xack messages vege 1605728515552-0
(integer) 1
127.0.0.1:6379> XREADGROUP group vege iva  streams messages 0 # "0" gives us the non-acknowledged ones
       1) 1) "1605728529174-0"
          2) 1) "vegetable"
             2) "tomato"
       2) 1) "1605728537148-0"
          2) 1) "vegetable"
             2) "onion"
 ```